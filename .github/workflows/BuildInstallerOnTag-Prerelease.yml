name: Build Prerelease Windows Installer

on:
  push:
    tags:
      - 'v[0-9]+\.[0-9]+\.[0-9]+-preview\.[0-9]'
      - 'v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]'

jobs:
  msi:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install tag tool
        run: dotnet tool install -g dotnetCampus.TagToVersion

      - name: Set tag to version
        shell: pwsh
        run: |
          echo "$env:USERPROFILE\.dotnet\tools" >> $env:GITHUB_PATH
          TagToVersion -t ${{ github.ref }}

      - name: Compute sanitized MSI version
        shell: pwsh
        run: |
          $tag = "$env:GITHUB_REF_NAME"
          if ($tag -match '^v(?<v>\d+\.\d+\.\d+)') { $v = $Matches['v'] } else { throw "Tag name '$tag' not in expected form" }
          echo "SANITIZED_VERSION=$v" >> $env:GITHUB_ENV

      - name: Sign in to NuGet (GitHub Packages)
        run: dotnet nuget add source --username michael-j-green --password ${{ secrets.NUGETKEY }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/gaseous-project/index.json"

      - name: Build MSI (Release)
        shell: pwsh
        run: |
          dotnet build .\installer\setup\Setup.wixproj -c Release -p:Version='${{ github.ref_name }}' -p:ProductVersion=$env:SANITIZED_VERSION

      - name: Rename MSI with tag
        shell: pwsh
        run: |
          $src = "installer/setup/bin/x64/Release/Setup.msi"
          if (!(Test-Path $src)) { throw "MSI not found at $src" }
          $dest = "GaseousServer-$env:GITHUB_REF_NAME-x64.msi"
          Copy-Item $src $dest -Force
          Write-Host "Created $dest"

      - name: Upload MSI to GitHub Release (prerelease)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            GaseousServer-${{ github.ref_name }}-x64.msi
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

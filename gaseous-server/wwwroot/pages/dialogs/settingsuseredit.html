<div id="properties_toc">
    <div id="properties_user_toc_password" name="properties_user_toc_item" onclick="UserSelectTab('password');">Password</div>
    <div id="properties_user_toc_role" name="properties_user_toc_item" onclick="UserSelectTab('role');">Role</div>
    <div id="properties_user_toc_age" name="properties_user_toc_item" onclick="UserSelectTab('age');">Content Restrictions</div>
    <!--<div id="properties_toc_manage" name="properties_toc_item" onclick="SelectTab('manage');">Manage</div>-->
</div>

<div id="properties_bodypanel" style="height: 450px; overflow-y: scroll;">
    <div id="properties_bodypanel_password" name="properties_user_tab" style="display: none;">
        <table style="width: 100%;">
            <tr>
                <th>
                    Password
                </th>
                <td>
                    <input type="password" id="settings_users_edit_password" style="width: 95%;" onkeyup="checkPasswordsMatch();" />
                </td>
            </tr>
            <tr>
                <th>
                    Confirm password
                </th>
                <td>
                    <input type="password" id="settings_users_edit_confirmpassword" style="width: 95%;" onkeyup="checkPasswordsMatch();" />
                </td>
            </tr>
            <tr>
                <td colspan="2" id="settings_users_edit_label"></td>
            </tr>
            <tr>
                <td colspan="2" id="settings_users_edit_errorlabel" style="color: red;"></td>
            </tr>
        </table>
    </div>

    <div id="properties_bodypanel_role" name="properties_user_tab" style="display: none;">
        <table style="width: 100%;" class="romtable">
            <tr>
                <th>
                    
                </th>
                <th>
                    <input type="radio" name="settings_user_role" id="settings_user_role_player" value="Player"> <label for="settings_user_role_player">Player</label>
                </th>
                <th>
                    <input type="radio" name="settings_user_role" id="settings_user_role_gamer" value="Gamer"> <label for="settings_user_role_gamer">Gamer</label>
                </th>
                <th>
                    <input type="radio" name="settings_user_role" id="settings_user_role_admin" value="Admin"> <label for="settings_user_role_admin">Administrator</label>
                </th>
            </tr>
            <tr>
                <th colspan="4"><h3>Games and ROMs</h3></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Play games</td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Download ROM images</td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Upload ROM images</td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Create and delete multidisk packages</td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Delete ROM images</td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Fix ROM image matches</td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr>
                <th colspan="4"><h3>Collections</h3></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Download packages</td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Create packages</td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Edit packages</td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Delete packages</td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr>
                <th colspan="4"><h3>Settings</h3></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Download firmware</td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">View background tasks</td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">View platform mapping</td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Modify platform mapping</td>
                <td class="romcell"></td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Manually start background tasks</td>
                <td class="romcell"></td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">View logs</td>
                <td class="romcell"></td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
            <tr class="romrow">
                <td class="romcell">Manage user accounts</td>
                <td class="romcell"></td>
                <td class="romcell"></td>
                <td class="romcell"><img src="/images/tick.svg" class="banner_button_image" /></td>
            </tr>
        </table>
    
    </div>

    <div id="properties_bodypanel_age" name="properties_user_tab" style="display: none;">
        <h3>Classification Restrictions</h3>
        <div id="properties_bodypanel_age_classification">
        </div>
        <input type="checkbox" id="properties_bodypanel_age_includeunclassified"> <label for="properties_bodypanel_age_includeunclassified">Include unclassified titles</label>
    </div>
</div>
<div style="width: 100%; padding-top: 10px; text-align: right;">
    <button id="settings_users_edit_okbutton" value="OK" onclick="saveProperties();">OK</button>
</div>

<script type="text/javascript">
    ajaxCall(
        '/api/v1.1/Account/users/' + modalVariables,
        'GET',
        function(result) {
            document.getElementById('modal-heading').innerHTML = result.emailAddress;

            // role page
            document.getElementById('settings_user_role_' + result.highestRole.toLowerCase()).checked = true;

            // age restriction page
            var ageRatingsContainer = document.getElementById('properties_bodypanel_age_classification');
            var ageRatingsTable = document.createElement('table');
            ageRatingsTable.style.width = '100%';
            ageRatingsTable.cellSpacing = 0;
            ageRatingsTable.appendChild(
                    createTableRow(
                        true, 
                        [ 
                            'Highest Allowed Rating',
                            'Included Ratings'
                        ],
                        '',
                        ''
                        )
                    );
            for (var ageGroup in AgeRatingGroups) {
                if (AgeRatingGroups.hasOwnProperty(ageGroup)) {
                    var ratingsValues = '';
                    var classBoards = AgeRatingGroups[ageGroup];

                    for (var classBoard in classBoards) {
                        for (var rating in classBoards[classBoard]) {
                            ratingsValues += "<img src='/images/Ratings/" + classBoard + "/" + AgeRatingStrings[classBoards[classBoard][rating]] + ".svg' class='rating_image_mini' />";
                        }
                    }

                    var radioCheckedState = '';
                    if (result.securityProfile.ageRestrictionPolicy.maximumAgeRestriction.toLowerCase() == ageGroup.toLocaleLowerCase()) {
                        radioCheckedState = "checked='checked'";
                    }

                    ageRatingsTable.appendChild(
                        createTableRow(
                            false, 
                            [ 
                                "<input type='radio' id='properties_bodypanel_age_classification_" + ageGroup + "' name='classification_group' " + radioCheckedState + " value='" + ageGroup + "' /> <label for='properties_bodypanel_age_classification_" + ageGroup + "'>" + ageGroup + "</label>",
                                ratingsValues
                            ],
                            'romrow',
                            'romcell'
                            )
                        );
                }
            }
            ageRatingsContainer.appendChild(ageRatingsTable);

            document.getElementById('properties_bodypanel_age_includeunclassified').checked = result.securityProfile.ageRestrictionPolicy.includeUnrated;
        },
        function(error) {
            closeDialog();
        } 
    );

    function UserSelectTab(TabName) {
        var tabs = document.getElementsByName('properties_user_tab');
        for (var i = 0; i < tabs.length; i++) {
            if ((tabs[i].id) == ("properties_bodypanel_" + TabName)) {
                tabs[i].style.display = '';
            } else {
                tabs[i].style.display = 'none';
            }
        }

        var tocs = document.getElementsByName('properties_user_toc_item');
        for (var i = 0; i < tocs.length; i++) {
            if ((tocs[i].id) == ("properties_user_toc_" + TabName)) {
                tocs[i].className = "properties_toc_item_selected";
            } else {
                tocs[i].className = '';
            }
        }
    }

    function checkPasswordsMatch() {
        var newPassword = document.getElementById('settings_users_edit_password').value;
        var conPassword = document.getElementById('settings_users_edit_confirmpassword').value;
        var errorLabel = document.getElementById('settings_users_edit_label');
        var submitButton = document.getElementById('settings_users_edit_okbutton');
        
        if (newPassword.length > 0) {
            if (newPassword == conPassword) {
                // check if password meets requirements
                if (newPassword.length >= 10) {
                    errorLabel.innerHTML = "";
                    submitButton.removeAttribute('disabled');
                    return true;
                } else {
                    errorLabel.innerHTML = "Password should be at least 10 characters long";
                    submitButton.setAttribute('disabled', 'disabled');
                    return false;
                }
            } else {
                errorLabel.innerHTML = "New and confirmed passwords do not match";
                submitButton.setAttribute('disabled', 'disabled');
                return false;
            }
        } else {
            errorLabel.innerHTML = "Password will not be changed";
            submitButton.removeAttribute('disabled');
            return true;
        }
    }

    function saveProperties() {
        saveRole();
    }

    function saveRole() {
        if (checkPasswordsMatch() == true) {
            // process role
            var selectedRole = $("input[type='radio'][name='settings_user_role']:checked").val();

            ajaxCall(
                '/api/v1.1/Account/users/' + modalVariables + '/Roles?RoleName=' + selectedRole,
                'POST',
                function(result) {
                    saveSecurityProfile();
                },
                function(error) {
                    saveSecurityProfile();
                }
            );
        }
    }

    function saveSecurityProfile() {
        if (checkPasswordsMatch() == true) {
            // process security profile
            var securityProfile = {
                "ageRestrictionPolicy": {
                    "maximumAgeRestriction": $("input[type='radio'][name='classification_group']:checked").val(),
                    "includeUnrated": document.getElementById('properties_bodypanel_age_includeunclassified').checked
                }
            };

            ajaxCall(
                '/api/v1.1/Account/users/' + modalVariables + '/SecurityProfile',
                'POST',
                function(result) {
                    savePassword();
                },
                function(error) {
                    savePassword();
                },
                JSON.stringify(securityProfile)
            );
        }
    }

    function savePassword() {
        console.log("Save Password");
        if (checkPasswordsMatch() == true) {
            console.log("Passwords match");
            var newPassword = document.getElementById('settings_users_edit_password').value;

            if (newPassword.length > 0) {
                console.log("New password value is long enough to commit to database");
                var model = {
                    "newPassword": newPassword,
                    "confirmPassword": newPassword
                }

                ajaxCall(
                    '/api/v1.1/Account/Users/' + modalVariables + '/Password',
                    'POST',
                    function(result) {
                        savePasswordsCallback(result);
                    },
                    function(error) {
                        savePasswordsCallback(error);
                    },
                    JSON.stringify(model)
                );
            } else {
                console.log("Password not long enough to change");
                savePropertiesCallback();
            }
        } else {
            console.log("Passwords don't match");
        }
    }

    function savePasswordsCallback(result) {
        console.log(result);
        if (result.succeeded == true) {
            savePropertiesCallback();
        } else {
            var errorBox = document.getElementById('settings_users_edit_errorlabel');
            errorBox.innerHTML = '';
            for (var i = 0; i < result.errors.length; i++) {
                var errorMessage = document.createElement('p');
                errorMessage.innerHTML = result.errors[i].description;
                errorBox.appendChild(errorMessage);
            }
        }
    }

    function savePropertiesCallback() {
        GetUsers();
        closeDialog();
    }

    UserSelectTab('password');
</script>
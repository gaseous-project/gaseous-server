<div id="gametitle">
    <h1 id="gametitle_label">Settings</h1>
</div>

<h3>Libraries</h3>
<table id="settings_libraries" class="romtable" style="width: 100%;" cellspacing="0">

</table>
<div style="text-align: right;"><button id="settings_newlibrary" onclick="showSubDialog('librarynew');">New Library</button></div>

<h2>Advanced Settings</h2>
<p><strong>Warning</strong> Do not modify the below settings unless you know what you're doing.</p>
<h3>Background Task Timers</h3>
<p>All intervals are in minutes.</p>
<table id="settings_tasktimers" class="romtable" style="width: 100%;" cellspacing="0">
    
</table>
<div style="text-align: right;"><button id="settings_tasktimers_default" onclick="defaultTaskTimers();">Reset to Default</button><button id="settings_tasktimers_new" onclick="saveTaskTimers();">Save</button></div>

<h3>Logging</h3>
<table cellspacing="0" style="width: 100%;">
    <tr>
        <th>
            Write logs
        </th>
        <td>
            <input type="radio" name="settings_logs_write" id="settings_logs_write_db" value="false" checked="checked"><label for="settings_logs_write_db"> To database only (default)</label>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <input type="radio" name="settings_logs_write" id="settings_logs_write_fs" value="true"><label for="settings_logs_write_fs"> To database and disk</label>
        </td>
    </tr>
    <tr>
        <td colspan="2">&nbsp;</td>
    </tr>
    <tr>
        <th>
            Minimum log retention (days):
        </th>
        <td>
            <input type="number" min="1" id="settings_logs_retention" />
        </td>
    </tr>
    <tr>
        <td colspan="2" style="text-align: right;">
            <button id="settings_tasktimers_new" onclick="setLoggingSettings();">Save</button>
        </td>
    </tr>
</table>

<script type="text/javascript">
    function drawLibrary() {
        ajaxCall(
            '/api/v1.1/Library',
            'GET',
            function (result) {
                var newTable = document.getElementById('settings_libraries');
                newTable.innerHTML = '';
                newTable.appendChild(createTableRow(true, ['Name', 'Path', 'Default Platform', 'Default Library', '']));

                for (var i = 0; i < result.length; i++) {
                    var platformName = '';
                    if (result[i].defaultPlatformId == 0) {
                        if (result[i].isDefaultLibrary == true) {
                            platformName = "n/a";
                        } else {
                            platformName = "";
                        }
                    } else {
                        platformName = result[i].defaultPlatformName;
                    }

                    var defaultLibrary = '';
                    if (result[i].isDefaultLibrary == true) {
                        defaultLibrary = "Yes";
                    } else {
                        defaultLibrary = "";
                    }

                    var deleteButton = '';
                    if (result[i].isDefaultLibrary == false) {
                        var deleteButton = '<a href="#" onclick="showSubDialog(\'librarydelete\', ' + result[i].id + ');" class="romlink"><img src="/images/delete.svg" class="banner_button_image" alt="Delete" title="Delete" /></a>';
                    }

                    newTable.appendChild(createTableRow(
                        false, 
                        [            
                            result[i].name,            
                            result[i].path,
                            platformName,
                            defaultLibrary,
                            '<div style="text-align: right;">' + deleteButton + '</div>'
                        ],
                        'romrow',
                        'romcell'
                    ));
                }
            }
        );
    }

    function getBackgroundTaskTimers() {
        ajaxCall(
            '/api/v1/System/Settings/BackgroundTasks/Intervals',
            'GET',
            function(result) {
                var targetTable = document.getElementById('settings_tasktimers');
                targetTable.innerHTML = '';

                targetTable.appendChild(
                    createTableRow(true, ['Background Task', 'Timer Interval', 'Default Interval', 'Minimum Allowed Interval'])
                );

                for (const [key, value] of Object.entries(result)) {
                    var newTableRow = createTableRow(
                        false,
                        [
                            GetTaskFriendlyName(value.task),
                            '<input id="settings_tasktimers_' + value.task + '" name="settings_tasktimers_values" data-name="' + value.task + '" data-default="' + value.defaultInterval + '" type="number" placeholder="0" min="' + value.minimumAllowedValue + '" value="' + value.interval + '" />',
                            value.defaultInterval,
                            value.minimumAllowedValue
                        ],
                        'romrow',
                        'romcell'
                    );
                    targetTable.appendChild(newTableRow);
                }
            }
        );
    }

    function saveTaskTimers() {
        var timerValues = document.getElementsByName('settings_tasktimers_values');

        var model = {};
        for (var i = 0; i < timerValues.length; i++) {
            model[timerValues[i].getAttribute('data-name')] = timerValues[i].value;
        }

        ajaxCall(
            '/api/v1/System/Settings/BackgroundTasks/Intervals',
            'POST',
            function(result) {
                getBackgroundTaskTimers();
            },
            function(error) {
                getBackgroundTaskTimers();
            },
            JSON.stringify(model)
        );
    }

    function defaultTaskTimers() {
        var timerValues = document.getElementsByName('settings_tasktimers_values');

        for (var i = 0; i < timerValues.length; i++) {
            timerValues[i].value = timerValues[i].getAttribute('data-default');
        }

        saveTaskTimers();
    }

    function getLoggingSettings() {
        ajaxCall(
            '/api/v1/System/Settings/System',
            'GET',
            function(result) {
                var optionToSelect = 'settings_logs_write_db';
                if (result.alwaysLogToDisk == true) {
                    optionToSelect = 'settings_logs_write_fs';
                }
                document.getElementById(optionToSelect).checked = true;

                document.getElementById('settings_logs_retention').value = result.minimumLogRetentionPeriod;
            }
        );
    }

    function setLoggingSettings() {
        var alwaysLogToDisk = false;
        if ($("input[type='radio'][name='settings_logs_write']:checked").val() == "true") {
            alwaysLogToDisk = true;
        }

        var retention = document.getElementById('settings_logs_retention');
        var retentionValue = 0;
        if (retention.value) {
            retentionValue = retention.value;
        } else {
            retentionValue = 7;
        }

        var model = {
            "alwaysLogToDisk": alwaysLogToDisk,
            "minimumLogRetentionPeriod": retentionValue
        };

        ajaxCall(
            '/api/v1/System/Settings/System',
            'POST',
            function(result) {
                getLoggingSettings();
            },
            function(error) {
                getLoggingSettings();
            },
            JSON.stringify(model)
        );
    }

    drawLibrary();
    getBackgroundTaskTimers();
    getLoggingSettings();
</script>
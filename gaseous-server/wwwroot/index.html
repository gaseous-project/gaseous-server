<!DOCTYPE html>
<html style="background-color: #000000;">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script type="text/javascript" src="/scripts/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/scripts/jquery.lazy.min.js"></script>
    <script type="text/javascript" src="/scripts/jquery.lazy.plugins.min.js"></script>
    <script type="text/javascript" src="/scripts/moment-with-locales.min.js"></script>
    <script type="text/javascript" src="/scripts/select2.min.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <title>Gaseous Games</title>

    <script type="text/javascript">
        // update src links to ensure the latest versions are always loaded.

        let styleSheets = [
            "/styles/select2.min.css",
            "/styles/stylevars.css",
            "/styles/style.css",
            "/styles/style-skinny.css",
            "/styles/notifications.css"
        ];

        let scriptLinks = [
            "/scripts/filtering.js",
            "/scripts/rendergames.js",
            "/scripts/main.js",
            "/scripts/simpleUpload.min.js",
            "/scripts/qrcode.min.js",
            "/scripts/modals.js",
            "/scripts/cards.js",
            "/scripts/usermgmt.js",
            "/scripts/platforms.js",
            "/scripts/logviewer.js",
            "/scripts/emulatorconfig.js",
            "/scripts/preferences.js",
            "/scripts/account.js",
            "/scripts/libraries.js",
            "/scripts/notifications.js",
            "/scripts/rominfo.js",
            "/scripts/uploadrom.js",
            "/scripts/screenshots.js"
        ];

        let head = document.getElementsByTagName('head')[0];

        // placeholder for global userProfile variable
        var userProfile;
    </script>
</head>

<body>
    <!-- Background Images -->
    <div id="bgImages"></div>
    <div id="bgImage_Opacity"></div>

    <!-- Notifications -->
    <div id="notifications_target"></div>

    <!-- Page Banner -->
    <div id="banner_target"></div>

    <!-- Page Content -->
    <div id="content"></div>

    <script type="text/javascript">
        // Gaseous Games - Main Application Script

        // start the application
        let AppVersion = "0.0.0";
        let DBSchemaVersion = "1000";
        let FirstRunStatus = "0";
        var AgeRatingMappings = {};
        let emulatorDebugMode = "false";
        let supportedMetadataSources = [];

        let backgroundImageHandler = undefined;
        let currentPage = null;
        let pageUnloadCallbacks = {};

        // Enhanced LoadPageContent function with proper unloading for SPA behavior
        async function LoadPageContent(page, targetDiv) {
            if (targetDiv == undefined || targetDiv == null || targetDiv == '') {
                targetDiv = 'content';
            }

            // For home/library pages, implement proper SPA page unloading
            if (['home', 'library'].includes(page) && targetDiv === 'content') {
                await unloadCurrentPage();
            }

            // load page content
            let pageContentResponse = await fetch('/pages/' + page + '.html' + '?v=' + AppVersion);
            let pageContentContent = await pageContentResponse.text();
            document.getElementById(targetDiv).innerHTML = pageContentContent;

            // Store current page for tracking
            if (targetDiv === 'content') {
                currentPage = page;
            }

            // For SPA pages, load script differently to avoid variable conflicts
            if (['home', 'library'].includes(page) && targetDiv === 'content') {
                // Load script content and execute in a way that avoids global variable conflicts
                let pageScriptResponse = await fetch('/pages/' + page + '.js' + '?v=' + AppVersion);
                let pageScriptContent = await pageScriptResponse.text();

                // Wrap the script content to avoid global variable conflicts
                let wrappedScript = `
                (function() {
                    // Clear any existing page variables to avoid conflicts
                    if (typeof coverURLList !== 'undefined') {
                        delete window.coverURLList;
                    }
                    if (typeof filter !== 'undefined') {
                        delete window.filter;
                    }
                    if (typeof gameRows !== 'undefined') {
                        delete window.gameRows;
                    }
                    if (typeof scrollTimer !== 'undefined') {
                        delete window.scrollTimer;
                    }
                    if (typeof loadedPages !== 'undefined') {
                        delete window.loadedPages;
                    }
                    if (typeof backgroundImageHandler !== 'undefined') {
                        // Stop any background image rotation timer
                        if (backgroundImageHandler && backgroundImageHandler.RotationTimer) {
                            clearInterval(backgroundImageHandler.RotationTimer);
                        }
                        delete window.backgroundImageHandler;
                    }
                    
                    // Execute the page script
                    ${pageScriptContent}
                })();
                `;

                // Create and execute the script
                let script = document.createElement('script');
                script.type = 'text/javascript';
                script.text = wrappedScript;
                document.head.appendChild(script);

                // Remove the script element after execution
                document.head.removeChild(script);
            } else {
                // Standard script loading for non-SPA pages
                let pageScriptLink = '/pages/' + page + '.js';
                let script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = pageScriptLink + '?v=' + AppVersion;
                script.async = false;
                document.head.appendChild(script);
            }

            // Note: backgroundImageHandler is initialized by individual pages as needed
        }

        // Function to unload current page with proper cleanup
        async function unloadCurrentPage() {
            if (!currentPage || !['home', 'library'].includes(currentPage)) {
                return;
            }

            console.log(`Unloading page: ${currentPage}`);

            // Call page-specific unload callback if it exists
            if (pageUnloadCallbacks[currentPage] && typeof pageUnloadCallbacks[currentPage] === 'function') {
                try {
                    await pageUnloadCallbacks[currentPage]();
                    console.log(`${currentPage} page cleanup completed`);
                } catch (error) {
                    console.error('Error during %s page cleanup:', currentPage, error);
                }
            }

            // General cleanup for all pages
            await performGeneralCleanup();
        }

        // General cleanup function
        async function performGeneralCleanup() {
            // Clear intervals and timeouts that might be running
            const highestTimeoutId = setTimeout(() => { }, 0);
            for (let i = 0; i < highestTimeoutId; i++) {
                clearTimeout(i);
            }

            const highestIntervalId = setInterval(() => { }, 0);
            for (let i = 0; i < highestIntervalId; i++) {
                clearInterval(i);
            }

            // Clear event listeners on elements that might have been added dynamically
            const contentDiv = document.getElementById('content');
            if (contentDiv) {
                // Remove all event listeners by cloning and replacing the element
                const newContentDiv = contentDiv.cloneNode(true);
                contentDiv.parentNode.replaceChild(newContentDiv, contentDiv);
            }

            // Clear any jQuery lazy loading instances
            if (typeof $.fn.lazy !== 'undefined') {
                try {
                    $('.lazy').each(function () {
                        if ($(this).data('plugin_lazy')) {
                            $(this).lazy('destroy');
                        }
                    });
                } catch (error) {
                    console.warn('Error cleaning up lazy loading:', error);
                }
            }

            // Clear any select2 instances
            if (typeof $.fn.select2 !== 'undefined') {
                try {
                    $('.select2-hidden-accessible').select2('destroy');
                } catch (error) {
                    console.warn('Error cleaning up select2 instances:', error);
                }
            }

            // Clear page-specific global variables
            if (typeof window.coverURLList !== 'undefined') {
                window.coverURLList = [];
            }
            if (typeof window.filter !== 'undefined') {
                window.filter = null;
            }
            if (typeof window.gameRows !== 'undefined') {
                window.gameRows = [];
            }
            if (typeof window.scrollTimer !== 'undefined') {
                if (window.scrollTimer) {
                    clearTimeout(window.scrollTimer);
                }
                window.scrollTimer = null;
            }
            if (typeof window.loadedPages !== 'undefined') {
                window.loadedPages = [];
            }
            if (typeof window.backgroundImageHandler !== 'undefined') {
                // Stop any background image rotation timer
                if (window.backgroundImageHandler && window.backgroundImageHandler.RotationTimer) {
                    clearInterval(window.backgroundImageHandler.RotationTimer);
                }
                window.backgroundImageHandler = undefined;
            }

            // Force garbage collection hint (if available)
            if (window.gc) {
                window.gc();
            }
        }

        // Function for pages to register their cleanup callbacks
        function registerPageUnloadCallback(pageName, callback) {
            pageUnloadCallbacks[pageName] = callback;
        }

        // Enhanced navigation function for SPA behavior
        async function navigateToPage(page) {
            if (['home', 'library'].includes(page) && ['home', 'library'].includes(currentPage)) {
                // SPA navigation between home and library
                console.log(`SPA navigation from ${currentPage} to ${page}`);
                await LoadPageContent(page, 'content');

                // Update URL without page reload
                const newUrl = `/index.html?page=${page}`;
                window.history.pushState({ page: page }, '', newUrl);
            } else {
                // Standard navigation for other pages
                window.location.href = `/index.html?page=${page}`;
            }
        }

        async function startApp() {
            // load /api/v1.1/System/Version
            await fetch('/api/v1.1/System/Version')
                .then(async response => {
                    if (response.ok) {
                        // get version information
                        let versionFile = await response.json();
                        AppVersion = versionFile.AppVersion;
                        DBSchemaVersion = versionFile.DBSchemaVersion;
                        FirstRunStatus = versionFile.FirstRunStatus;
                        emulatorDebugMode = versionFile.emulatorDebugMode;
                        supportedMetadataSources = versionFile.SupportedMetadataSources;

                        // load age rating mappings
                        AgeRatingMappings = await fetch('/images/Ratings/AgeGroupMap.json')
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                } else {
                                    throw new Error('Failed to load age rating mappings');
                                }
                            })
                            .catch(error => {
                                console.error(error);
                                return {};
                            });

                        // load scripts and style files
                        // update script links
                        for (const scriptLink of scriptLinks) {
                            let newScript = document.createElement('script');
                            newScript.src = scriptLink + '?v=' + AppVersion;
                            newScript.type = "text/javascript";
                            newScript.async = false;

                            head.appendChild(newScript);
                        }

                        // update stylesheet links
                        for (const styleSheet of styleSheets) {
                            let newLink = document.createElement('link');
                            newLink.rel = "stylesheet";
                            newLink.href = styleSheet + '?v=' + AppVersion;
                            newLink.type = "text/css";

                            head.appendChild(newLink);
                        }

                        // wait for all scripts to load
                        do {
                            if (typeof getQueryString === "function") {
                                break;
                            }
                            console.log("Waiting for scripts to load...");
                            await new Promise(r => setTimeout(r, 100));
                        } while (typeof getQueryString !== "function");

                        // start the application
                        console.log("Starting Gaseous");
                        console.log("App Version: " + AppVersion);
                        console.log("First Run Status: " + FirstRunStatus);
                        switch (FirstRunStatus) {
                            case 0:
                            case "0":
                                // first run - load first run wizard
                                // clear any database data
                                DeleteAllDatabases();

                                // load first stage of wizard
                                await LoadPageContent('first', 'content');
                                break;

                            default:
                                // first run - load login page or redirect if user already logged in

                                await fetch('/api/v1.1/Account/Profile/Basic')
                                    .then(async response => {
                                        if (response.ok) {
                                            // user is signed in - start setting up the application
                                            console.log("User is logged in");
                                            userProfile = await response.json();

                                            switch (FirstRunStatus) {
                                                case "1": {
                                                    // first run - load second stage of wizard

                                                    DeleteAllDatabases();

                                                    // load first stage of wizard
                                                    await LoadPageContent('first2', 'content');
                                                    break;
                                                }

                                                default: {
                                                    // load page banner
                                                    await LoadPageContent('banner', 'banner_target');

                                                    // start notifications
                                                    startNotificationFetch();

                                                    // load page content
                                                    let pageSelection = getQueryString('page', 'string');

                                                    if (!pageSelection) {
                                                        pageSelection = GetPreference("Library.DefaultHomePage");
                                                    }
                                                    console.log("Loading page: " + pageSelection);
                                                    await LoadPageContent(pageSelection, 'content');

                                                    // Set initial state for browser navigation
                                                    if (['home', 'library'].includes(pageSelection)) {
                                                        window.history.replaceState({ page: pageSelection }, '', window.location.href);
                                                    }

                                                    // restore any open game cards
                                                    if (['home', 'library'].includes(pageSelection)) {
                                                        let gameCard = sessionStorage.getItem('Card.game.Id');
                                                        if (gameCard) {
                                                            console.log("Restoring game card: " + gameCard);

                                                            let gameCardInstance = new GameCard(gameCard);
                                                            gameCardInstance.ShowCard();
                                                        }
                                                    }

                                                    // add event listener for escape key
                                                    document.addEventListener("keydown", (event) => {
                                                        if (event.key === "Escape") {
                                                            let modalBackgrounds = document.getElementsByClassName('modal-background');
                                                            if (modalBackgrounds.length === 1) {
                                                                // set the scroll bar back to auto
                                                                document.body.style.overflow = 'auto';

                                                                // Remove all keys from session storage that start with "Card."
                                                                let keys = Object.keys(sessionStorage);
                                                                keys.forEach(key => {
                                                                    if (key.startsWith("Card.")) {
                                                                        sessionStorage.removeItem(key);
                                                                    }
                                                                });
                                                            }

                                                            // remove the last modal in modalBackgrounds
                                                            if (modalBackgrounds.length > 0) {
                                                                let modalBackground = modalBackgrounds[modalBackgrounds.length - 1];
                                                                modalBackground.parentNode.removeChild(modalBackground);
                                                            }
                                                        }
                                                    });

                                                    // Add browser back/forward navigation support for SPA
                                                    window.addEventListener('popstate', async (event) => {
                                                        if (event.state && event.state.page) {
                                                            console.log('Browser navigation to:', event.state.page);
                                                            await LoadPageContent(event.state.page, 'content');
                                                        } else {
                                                            // Fallback to query string if no state
                                                            let pageFromUrl = getQueryString('page', 'string');
                                                            if (pageFromUrl && ['home', 'library'].includes(pageFromUrl)) {
                                                                await LoadPageContent(pageFromUrl, 'content');
                                                            }
                                                        }
                                                    });

                                                    break;
                                                }
                                            }
                                        } else {
                                            // user is not signed in - load login page

                                            // clear any database data
                                            DeleteAllDatabases();

                                            // load login page
                                            await LoadPageContent('login');
                                        }
                                    })
                                    .catch(async (error) => {
                                        console.log(error);
                                        DeleteAllDatabases();
                                        await LoadPageContent('login');
                                    });
                                break;
                        }
                    }
                })
                .catch(async (error) => {
                    console.log(error);
                });

            console.log("Gaseous Games started successfully");
        }

        function DeleteAllDatabases() {
            indexedDB.deleteDatabase('gaseous');
            indexedDB.deleteDatabase('EmulatorJS-roms');
            indexedDB.deleteDatabase('EmulatorJS-bios');
            indexedDB.deleteDatabase('EmulatorJS-core');
            indexedDB.deleteDatabase('/data/saves');

            localStorage.clear();
        }

        window.document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
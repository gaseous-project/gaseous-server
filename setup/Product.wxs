<?xml version="1.0" encoding="UTF-8"?>
<?include Variables.wxi?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="Gaseous Server" Manufacturer="Gaseous Project" Version="1.0.0" Scope="perMachine" UpgradeCode="{E5C6652E-9A1F-43E3-9A62-5A9A5D4C8F92}">
    <SummaryInformation Description="Installs Gaseous Server and configures MariaDB connection" />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="$(var.InstallDirName)" />
    </StandardDirectory>

    <!-- ProgramData for default configuration path when running as a service -->
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="GASEOUS_PROGDATA" Name="Gaseous" />
    </StandardDirectory>

    <!-- Feature: harvested publish files + env vars + ProgramData folder creation -->
    <Feature Id="MainFeature" Title="Gaseous Server" Level="1">
      <ComponentGroupRef Id="PublishFiles" />
      <ComponentRef Id="EnvVars" />
      <ComponentRef Id="ProgDataFolder" />
    </Feature>

    <!-- Environment variables set machine-wide to guide the server to DB settings and config path -->
    <Component Id="EnvVars" Guid="{0B1F9D1E-5B7A-4F4A-9EAF-4D8276E8F986}" Directory="INSTALLFOLDER">
      <util:Environment Id="EnvDbHost" Name="dbhost" Action="set" System="yes" Part="all" Value="[DBHOST]"/>
      <util:Environment Id="EnvDbPort" Name="dbport" Action="set" System="yes" Part="all" Value="[DBPORT]"/>
      <util:Environment Id="EnvDbUser" Name="dbuser" Action="set" System="yes" Part="all" Value="[DBUSER]"/>
      <util:Environment Id="EnvConfigPath" Name="GASEOUS_CONFIG_PATH" Action="set" System="yes" Part="all" Value="[CommonAppDataFolder]Gaseous"/>
    </Component>

    <!-- Ensure ProgramData\Gaseous exists -->
    <Component Id="ProgDataFolder" Guid="{B5D6C21B-35C6-40B4-8F5F-0E8D6A1E2E24}" Directory="GASEOUS_PROGDATA">
      <CreateFolder />
    </Component>

    <!-- UI to collect DB settings -->
    <Property Id="DBHOST" Value="$(var.DbHost)" />
    <Property Id="DBPORT" Value="$(var.DbPort)" />
    <Property Id="DBUSER" Value="$(var.DbUser)" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <UI>
      <!-- Use standard InstallDir UI as a base (from Wix UI extension) -->
      <UIRef Id="WixUI_InstallDir" />
      <Dialog Id="DbConfigDlg" Width="370" Height="200" Title="MariaDB Configuration">
        <Control Id="HostLabel" Type="Text" X="15" Y="50" Width="120" Height="15" Text="Host:" />
        <Control Id="HostEdit" Type="Edit" X="140" Y="48" Width="200" Height="18" Property="DBHOST" />
        <Control Id="PortLabel" Type="Text" X="15" Y="78" Width="120" Height="15" Text="Port:" />
        <Control Id="PortEdit" Type="Edit" X="140" Y="76" Width="200" Height="18" Property="DBPORT" />
        <Control Id="UserLabel" Type="Text" X="15" Y="106" Width="120" Height="15" Text="User name:" />
        <Control Id="UserEdit" Type="Edit" X="140" Y="104" Width="200" Height="18" Property="DBUSER" />
        <ControlRef Id="Back"/>
        <ControlRef Id="Next"/>
        <ControlRef Id="Cancel"/>
      </Dialog>

  <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="DbConfigDlg">1</Publish>
  <Publish Dialog="DbConfigDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg">1</Publish>
  <Publish Dialog="DbConfigDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
    </UI>
  </Package>
</Wix>
